# totp-sshd-jumpcontainer
This is a TOTP-enabled SSH daemon in a container used as DMZ jump-host.

(c) 2023 Copyright: Matthias Goebl (e-mail: matthias dot goebl at goebl dot net)

Published under the Apache License Version 2.0

## About

This is a container to be used a jump-host to an internal machine.
The container runtime serves as [DMZ](https://en.wikipedia.org/wiki/DMZ_(computing)).
The container's ssh port must be exposed to the internet, so you can login - either via ssh public key or username/password together with a time-base OTP code.
Once you are logged in, you can jump on via ssh to your internal target system.

Currently it's quite simple: Only one user, one password, one TOTP secret. No user database.
The password and secret can be passed via environment. Otherwise credentials are created and
listed on stdout - so keep your logs secret.

## Configuration

The following variables can be set upon startup:

- JUMPHOST: used as name of the issuer when generating the [otp secret QR code](https://github.com/google/google-authenticator/wiki/Key-Uri-Format)
- JUMPUSER: username for login
- JUMPPASS: password for login
- JUMPTOTP: [base32](https://en.wikipedia.org/wiki/Base32) encoded secret for
  [OTP code generation](https://en.wikipedia.org/wiki/Time-based_one-time_password),
  generated by [Google Authenticator](https://en.wikipedia.org/wiki/Google_Authenticator)
  or any [TOTP app](https://en.wikipedia.org/wiki/Comparison_of_OTP_applications).
- JUMPKEY: SSH public key, take it from your `~/.ssh/id_rsa.pub`

You can set them when launching the container in docker (try `make imagerun`)
or within a kubernetes deployment (see [jumpcontainer-deployment.yaml](jumpcontainer-deployment.yaml) for an example).

If you don't pass above variables, defauls are assumed and credentials are created.
The credentials including a QR code for your authenticator app are listed on stdout - so please keep your logs secret.

Example startup output:

```
ssh-keygen: generating new host keys: RSA ECDSA ED25519 
---
BUILD: 20231219.204954
JUMPUSER: jumper
JUMPPASS: 123
JUMPTOTP: LT2MSLFXAW7YT4Z65RVCAO2VFU
JUMPKEY: ssh-rsa ABC...= user@laptop
First TOTP code: 266877
QR code URL: otpauth://totp/jumpcontainer:jumper%20123%202023-12-19?secret=LT2MSLFXAW7YT4Z65RVCAO2VFU&issuer=jumpcontainer
█████████████████████████████████████████████
█████████████████████████████████████████████
████ ▄▄▄▄▄ █   █▄▀██  ▄█ ▀██▄ ▀▄ █ ▄▄▄▄▄ ████
████ █   █ █ ▀▄ █▄█▄▄▀▀▀█   ▄▀▀▄▀█ █   █ ████
████ █▄▄▄█ █▀██▀▀█▄█ █▀▄▄ ▀▄  ▄▄ █ █▄▄▄█ ████
████▄▄▄▄▄▄▄█▄▀▄█ █ ▀▄█ ▀ █▄█ █ ▀▄█▄▄▄▄▄▄▄████
████  ▀▀▄ ▄██▀▀▄ ▄█▄ ▀█  ▀ ▀▀▀█▀ ▀█▄▀ ▄ ▄████
█████▄▀█▄█▄▀▄▀▄ █ █▀▄ ▄▄█▄▀▄ ▄█▄  █ ▀▄ ██████
█████▀▀█ ▄▄█  ██ ▄▄▄ ▀█▀█▀  █▀  ▀▄▄▄▀█  ▄████
█████▀█▀ ▄▄█▄ █▀▀█ ▀▄▀██▄ ▄ ▄▀█▄ ▄▀ █  ██████
█████▄█ ▀▄▄███▄▄█▄█▄  ▄  ▀ █ ▄▄ ▄▄▄█▀▄ █▄████
████▀ ▄█▀█▄█▄▀  ▄▄▀▄ ▀ █ ▄  ▀ ▄▄ █ █  ▀▀█████
████▀▀▀▄█▀▄▄ ▄█▄▀▄█▄▄    ▀   ▀▄▀ ▄▄▄▀▀ ▀▄████
████▀ ▀▀▀ ▄█▀▀▀█▄█▄▀▀█▀ ▄▄▀ ▀██ █▀   ▀▀▀█████
████▀ ▄ █▄▄▀█▄▀▄█▄▄▄▀ █  ▀▀█   ▀▀ ▄ ▀▀  ▄████
███████▄██▄█  ▄▄█▀█ █▄▀ ▄ ▄ ███▄▄▀████▀█▀████
████▄▄▄▄▄█▄▄ ▀▀▄█▄███▀█▄█▀ ▀ ▀ ▄ ▄▄▄  ▄▄█████
████ ▄▄▄▄▄ █▀ ▀ █ ▀ █▀█▄▀ █ ██▀█ █▄█ ▄ █▀████
████ █   █ █▄█ ▄▀▄███▀ ▄▀▀██ ▀█▀▄  ▄▄▀ █▄████
████ █▄▄▄█ █▀▄▀   ▀▄▀▀ ██▀█ █▄  █ ▄▄██▀ █████
████▄▄▄▄▄▄▄█▄▄▄▄█▄▄▄█▄▄█▄█▄▄█▄█▄█▄▄█▄▄▄▄▄████
█████████████████████████████████████████████
█████████████████████████████████████████████
Server listening on 0.0.0.0 port 2222.

```

## Security
It runs as non-root user 10001, so it it satisfies
[kubesec's requirement RUNASUSER>10000](https://kubesec.io/basics/containers-securitycontext-runasuser/)
and allows to maintain a [Pod Security Admission](https://kubernetes.io/docs/concepts/security/pod-security-admission/)
level of [restricted](https://kubernetes.io/docs/concepts/security/pod-security-standards/#restricted).

## References

It's based on https://wiki.alpinelinux.org/wiki/Setting_up_a_SSH_server
and https://wiki.alpinelinux.org/wiki/HOWTO_OpenSSH_2FA_with_password_and_Google_Authenticator.
